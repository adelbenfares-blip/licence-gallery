<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Licence Gallery</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #fff;
      color: #111;
    }

    header {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    strong {
      font-size: 18px;
      letter-spacing: .02em;
    }

    .muted {
      color: #666;
      font-size: 14px;
    }

    select, button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    button:disabled {
      opacity: .4;
      cursor: not-allowed;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    @media (min-width: 640px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (min-width: 900px) {
      .grid { grid-template-columns: repeat(5, 1fr); }
    }

    @media (min-width: 1200px) {
      .grid { grid-template-columns: repeat(7, 1fr); }
    }

    a.tile {
      display: block;
      border-radius: 14px;
      overflow: hidden;
      background: #f3f3f3;
      position: relative;
      aspect-ratio: 3 / 4;
    }

    a.tile:hover {
      outline: 2px solid #111;
      outline-offset: -2px;
    }

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .pager {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>

<header>
  <strong>HOT WHEELS</strong>
  <span class="muted" id="count"></span>

  <span class="muted">Retailer:</span>
  <select id="retailer"></select>
</header>

<div class="grid" id="grid"></div>

<div class="pager">
  <button id="prev">Prev</button>
  <span class="muted" id="pageInfo"></span>
  <button id="next">Next</button>
</div>

<script>
  const PAGE_SIZE = 200;

  const params = new URLSearchParams(location.search);
  const page = Math.max(1, parseInt(params.get("page") || "1", 10));
  const retailerParam = (params.get("retailer") || "all").toLowerCase();

  const gridEl = document.getElementById("grid");
  const countEl = document.getElementById("count");
  const pageInfoEl = document.getElementById("pageInfo");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  const retailerSel = document.getElementById("retailer");

  function setUrl(newPage, retailer) {
    const p = new URLSearchParams(location.search);
    p.set("page", String(newPage));
    if (retailer && retailer !== "all") p.set("retailer", retailer);
    else p.delete("retailer");
    location.search = p.toString();
  }

  function normaliseRetailer(r) {
    return (r || "other").toLowerCase();
  }

  function niceLabel(r) {
    const map = {
      zara: "Zara",
      hm: "H&M",
      next: "Next",
      asos: "ASOS",
      zalando: "Zalando",
      pinterest: "Pinterest",
      boxlunch: "BoxLunch",
      pacsun: "PacSun",
      bucketsandspades: "Buckets & Spades",
      other: "Other"
    };
    return map[r] || r;
  }

  async function init() {
    const res = await fetch("data/hot-wheels.json", { cache: "no-store" });
    const all = await res.json();

    // Build retailer list dynamically
    const retailers = Array.from(
      new Set(all.map(x => normaliseRetailer(x.retailer)))
    ).sort();

    retailerSel.innerHTML = "";
    retailerSel.append(new Option("All", "all"));
    retailers.forEach(r => retailerSel.append(new Option(niceLabel(r), r)));

    retailerSel.value = retailerParam;
    retailerSel.onchange = () => setUrl(1, retailerSel.value);

    const filtered = retailerParam === "all"
      ? all
      : all.filter(x => normaliseRetailer(x.retailer) === retailerParam);

    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    const currentPage = Math.min(page, totalPages);

    const start = (currentPage - 1) * PAGE_SIZE;
    const items = filtered.slice(start, start + PAGE_SIZE);

    countEl.textContent = total
      ? `${total} items`
      : "No items yet";

    pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;

    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;

    prevBtn.onclick = () => setUrl(currentPage - 1, retailerSel.value);
    nextBtn.onclick = () => setUrl(currentPage + 1, retailerSel.value);

    gridEl.innerHTML = "";

    for (const p of items) {
      const a = document.createElement("a");
      a.className = "tile";
      a.href = p.product_url;
      a.target = "_blank";
      a.rel = "noreferrer";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = p.image_url;
      img.alt = "";

      // Hide broken images completely
      img.onerror = () => {
        a.remove();
      };

      a.appendChild(img);
      gridEl.appendChild(a);
    }
  }

  init();
</script>

</body>
</html>
